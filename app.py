import streamlit as st
import datetime

# --- é¡µé¢è®¾ç½® ---
st.set_page_config(page_title="æ˜“ç»çœ‹ç›˜ (ç™½è¯ç‰ˆ)", page_icon="ğŸ“ˆ", layout="centered")

# --- æ ¸å¿ƒå·¥å…·ï¼šåŒ—äº¬æ—¶é—´ ---
def get_beijing_time():
    utc_now = datetime.datetime.utcnow()
    return utc_now + datetime.timedelta(hours=8)

# --- æ ¸å¿ƒå·¥å…·ï¼šé€šä¿—è§£è¯»é€»è¾‘ ---
def get_plain_interpretation(upper_code, lower_code):
    """
    å°†äº”è¡Œç”Ÿå…‹ç›´æ¥ç¿»è¯‘æˆè‚¡å¸‚æœ¯è¯­
    1,2=é‡‘ | 3=ç« | 4,5=æœ¨ | 6=æ°´ | 7,8=åœŸ
    """
    # å®šä¹‰äº”è¡Œ
    elements = {1:'é‡‘', 2:'é‡‘', 3:'ç«', 4:'æœ¨', 5:'æœ¨', 6:'æ°´', 7:'åœŸ', 8:'åœŸ'}
    u_e = elements[upper_code] # ä¸Šå¦ (ä»£è¡¨å¤§ç¯å¢ƒ/å‹åŠ›/ç»“æœ)
    l_e = elements[lower_code] # ä¸‹å¦ (ä»£è¡¨è‡ªèº«/æ”¯æ’‘/åŸºç¡€)
    
    # --- æ ¸å¿ƒåˆ¤æ–­é€»è¾‘ ---
    
    # 1. æ¯”å’Œ (äº”è¡Œç›¸åŒ) -> éœ‡è¡/ä¸»åŠ›æ§ç›˜
    if u_e == l_e:
        return {
            "signal": "âš–ï¸ æ¨ªç›˜éœ‡è¡",
            "score": 50,
            "color": "orange",
            "comment": "å¤šç©ºåŠ›é‡å¹³è¡¡ï¼Œæ–¹å‘ä¸æ˜ã€‚",
            "advice": "ã€è§‚æœ›ã€‘ä¸»åŠ›å¯èƒ½åœ¨æ´—ç›˜ï¼Œä¸è¦è¿½é«˜ï¼Œé€‚åˆåšTæˆ–ä¸åŠ¨ã€‚"
        }
    
    # 2. ç›¸ç”Ÿ (äº’å¸®äº’åŠ©) -> ä¸Šæ¶¨/æ”¯æ’‘å¼º
    # è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šä¸‹ç”Ÿä¸Š(æ³„æ°”/å›è°ƒ)ï¼Œä¸Šç”Ÿä¸‹(æ”¯æ’‘/åˆ©å¥½)ï¼Œæœ¨ç”Ÿç«(åˆ©å¥½ç§‘æŠ€)
    
    # ç‰¹æ®Šå‰åˆ©ç»„åˆ
    if (u_e == 'ç«' and l_e == 'æœ¨'): # æœ¨ç«é€šæ˜
        return {
            "signal": "ğŸ”¥ çˆ†å‘æ‹‰å‡",
            "score": 90,
            "color": "red",
            "comment": "é¢˜æçƒ­åº¦æé«˜ï¼Œèµ„é‡‘æ¶Œå…¥ï¼ŒåŠ¿å¤´å¾ˆçŒ›ã€‚",
            "advice": "ã€è¿›æ”»ã€‘æŒè‚¡å¾…æ¶¨ï¼Œå¦‚æœæ˜¯çƒ­é—¨å‰æ’è‚¡å¯ä»¥å…³æ³¨ã€‚"
        }
    
    if (u_e == 'åœŸ' and l_e == 'é‡‘') or (l_e == 'åœŸ' and u_e == 'é‡‘'): # åœŸé‡‘ç›¸ç”Ÿ
        return {
            "signal": "ğŸ“ˆ ç¨³å¥ä¸Šæ¶¨",
            "score": 80,
            "color": "red",
            "comment": "åº•éƒ¨æ”¯æ’‘éå¸¸æ‰å®ï¼Œä»·å€¼å›å½’ã€‚",
            "advice": "ã€æŒæœ‰ã€‘è¶‹åŠ¿å‘å¥½ï¼Œä¸ç”¨æ‹…å¿ƒçŸ­æœŸæ³¢åŠ¨ã€‚"
        }

    # ä¸€èˆ¬ç›¸ç”Ÿ
    is_generating = False
    # æ°´ç”Ÿæœ¨, æœ¨ç”Ÿç«, ç«ç”ŸåœŸ, åœŸç”Ÿé‡‘, é‡‘ç”Ÿæ°´
    pairs = [('æ°´','æœ¨'), ('æœ¨','ç«'), ('ç«','åœŸ'), ('åœŸ','é‡‘'), ('é‡‘','æ°´')]
    if (u_e, l_e) in pairs or (l_e, u_e) in pairs:
        return {
            "signal": "ğŸŒ¤ï¸ å°å¹…ä¸Šæ¶¨",
            "score": 70,
            "color": "red",
            "comment": "ç›˜é¢æœ‰æ”¯æ’‘ï¼Œäººæ°”åœ¨èšé›†ã€‚",
            "advice": "ã€ä½å¸ã€‘å¦‚æœæœ‰å›è¸©æ˜¯æœºä¼šï¼Œæ•´ä½“çœ‹å¤šã€‚"
        }

    # 3. ç›¸å…‹ (æ‰“æ¶/å†²çª) -> ä¸‹è·Œ/è°ƒæ•´
    # é‡‘å…‹æœ¨, æœ¨å…‹åœŸ, åœŸå…‹æ°´, æ°´å…‹ç«, ç«å…‹é‡‘
    
    # ç‰¹æ®Šå‡¶é™©ç»„åˆ
    if (u_e == 'ç«' and l_e == 'é‡‘'): # ç«å…‹é‡‘ (è¿™æ­£æ˜¯æ±‰å®‡é›†å›¢æœ€æ€•çš„ï¼Œå®ƒæ˜¯æœºæ¢°/é‡‘)
        return {
            "signal": "ğŸ“‰ æ‰¿å‹å›è½",
            "score": 30,
            "color": "green",
            "comment": "æŠ›å‹å¾ˆé‡ï¼Œåˆ©å¥½å…‘ç°ï¼Œä¸Šæ–¹æœ‰å¥—ç‰¢ç›˜ã€‚",
            "advice": "ã€å‡ä»“ã€‘å»ºè®®é€¢é«˜å–å‡ºï¼Œä¸è¦æ¥é£åˆ€ã€‚"
        }
        
    if (u_e == 'æ°´' and l_e == 'ç«'): # æ°´ç«ä¸å®¹
        return {
            "signal": "â›ˆï¸ å¤§å¹…è·³æ°´",
            "score": 20,
            "color": "green",
            "comment": "çªå‘åˆ©ç©ºæˆ–æƒ…ç»ªå´©æºƒï¼Œèµ„é‡‘å‡ºé€ƒã€‚",
            "advice": "ã€æ­¢æŸã€‘é£é™©è¾ƒå¤§ï¼Œå…ˆå‡ºæ¥é¿é™©ã€‚"
        }

    # å…¶ä»–ç›¸å…‹
    return {
        "signal": "ğŸŒ§ï¸ éœ‡è¡ä¸‹è¡Œ",
        "score": 40,
        "color": "green",
        "comment": "åˆ†æ­§è¾ƒå¤§ï¼Œä¸Šæ¶¨ä¹åŠ›ã€‚",
        "advice": "ã€é˜²å®ˆã€‘å¤šçœ‹å°‘åŠ¨ï¼Œç­‰å¾…å±€åŠ¿æ˜æœ—ã€‚"
    }

# --- ç®—å¦å‡½æ•° (ä¿æŒåŸæ•°å­¦é€»è¾‘) ---
def get_hex_data_time():
    now = get_beijing_time()
    s = now.year + now.month + now.day
    u = s % 8 or 8
    l = (s + now.hour) % 8 or 8
    return u, l

def get_hex_data_stock(code):
    s_code = str(code).zfill(6)
    head = sum(int(x) for x in s_code[:3])
    tail = sum(int(x) for x in s_code[3:])
    u = head % 8 or 8
    l = tail % 8 or 8
    
    # ç»“åˆæ—¶è¾°è®©ä¸ªè‚¡æ¯å¤©ç”šè‡³æ¯å°æ—¶éƒ½æœ‰ç»†å¾®å˜åŒ–
    now = get_beijing_time()
    # æ—¢ç„¶æ˜¯æ—¥å†…æ¨æ¼”ï¼Œæˆ‘ä»¬ç”¨ã€å°æ—¶ã€‘æ¥å¾®è°ƒä¸‹å¦ï¼Œæ¨¡æ‹Ÿç›˜ä¸­æ³¢åŠ¨
    # ä½†ä¸ºäº†ç¨³å®šï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯ç”¨å›ºå®šç®—æ³•ï¼Œæˆ–è€…æ ¹æ®ä¸Šä¸‹åˆå˜åŠ¨
    # è¿™é‡Œä¿æŒåŸé€»è¾‘ï¼š
    return u, l

# --- ç•Œé¢æ˜¾ç¤ºé€»è¾‘ ---
now_bj = get_beijing_time()
st.title("ğŸ“Š æ˜“ç»çœ‹ç›˜ (ç™½è¯ç‰ˆ)")
st.info(f"ğŸ“… åŒ—äº¬æ—¶é—´ï¼š{now_bj.strftime('%mæœˆ%dæ—¥ %H:%M')}")

# === æœºå™¨äººæ¿å— ===
st.divider()
st.subheader("ğŸ¤– æœºå™¨äººæ¿å—")
u1, l1 = get_hex_data_time()
res1 = get_plain_interpretation(u1, l1)

# å¤§å­—æ˜¾ç¤ºä¿¡å·
if res1['color'] == 'red':
    st.error(f"### {res1['signal']}") # Streamlité‡Œ erroræ˜¯çº¢è‰²èƒŒæ™¯
elif res1['color'] == 'green':
    st.success(f"### {res1['signal']}") # Streamlité‡Œ successæ˜¯ç»¿è‰²èƒŒæ™¯
else:
    st.warning(f"### {res1['signal']}") # warningæ˜¯é»„è‰²

st.write(f"**ğŸ—£ï¸ ç›˜é¢ç‚¹è¯„ï¼š** {res1['comment']}")
st.write(f"**ğŸ’¡ æ“ä½œå»ºè®®ï¼š** {res1['advice']}")

# === æ±‰å®‡é›†å›¢ ===
st.divider()
st.subheader("ğŸ­ æ±‰å®‡é›†å›¢ (300403)")
u2, l2 = get_hex_data_stock(300403)
# è¿™é‡Œåšä¸€ä¸ªç‰¹æ®Šçš„å¾®è°ƒï¼Œè®©æ±‰å®‡é›†å›¢ç»“åˆå½“å‰çš„å°æ—¶äº§ç”Ÿå˜åŒ–
# å¦‚æœç°åœ¨æ˜¯ä¸‹åˆ(13ç‚¹å)ï¼Œç¨å¾®å¼•å…¥ä¸€ç‚¹å˜é‡ï¼Œæ¨¡æ‹Ÿç›˜ä¸­å˜åŒ–
if now_bj.hour >= 13:
    l2 = (l2 + 1) % 8 or 8 

res2 = get_plain_interpretation(u2, l2)

# å¤§å­—æ˜¾ç¤ºä¿¡å·
if res2['color'] == 'red':
    st.error(f"### {res2['signal']}") 
elif res2['color'] == 'green':
    st.success(f"### {res2['signal']}")
else:
    st.warning(f"### {res2['signal']}")

st.write(f"**ğŸ—£ï¸ ä¸ªè‚¡ç‚¹è¯„ï¼š** {res2['comment']}")
st.write(f"**ğŸ’¡ æ“ä½œå»ºè®®ï¼š** {res2['advice']}")

# === åº•éƒ¨ ===
st.divider()
if st.button("ğŸ”„ åˆ·æ–°æœ€æ–°èµ°åŠ¿"):
    st.rerun()

st.caption("æ³¨ï¼šçº¢è‰²ä»£è¡¨åˆ©å¥½/ä¸Šæ¶¨ï¼Œç»¿è‰²ä»£è¡¨é£é™©/ä¸‹è·Œï¼Œé»„è‰²ä»£è¡¨éœ‡è¡ã€‚ä»…ä¾›å¨±ä¹ã€‚")
